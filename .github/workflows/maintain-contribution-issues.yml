name: Maintain Contribution Issues

on:
  issues:
    types: [closed]
  schedule:
    # Run daily at 00:00 UTC to ensure we always have 3 open issues
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  issues: write

jobs:
  maintain-issues:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check contribution issue count
      id: check
      run: |
        # Count open issues with "contribution" label
        OPEN_COUNT=$(gh issue list --label contribution --state open --json number --jq 'length')
        echo "Found $OPEN_COUNT open contribution issues"
        
        # Calculate how many we need to create
        TARGET=3
        NEEDED=$((TARGET - OPEN_COUNT))
        
        if [ $NEEDED -gt 0 ]; then
          echo "need_to_create=$NEEDED" >> $GITHUB_OUTPUT
          echo "Need to create $NEEDED more issue(s) to maintain $TARGET open issues"
        else
          echo "need_to_create=0" >> $GITHUB_OUTPUT
          echo "Already have $TARGET or more open issues"
        fi
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
    
    - name: Create contribution issues
      if: steps.check.outputs.need_to_create > 0
      run: |
        NEEDED=${{ steps.check.outputs.need_to_create }}
        CURRENT_MONTH=$(date +%m)
        
        # Determine labels based on month
        if [ "$CURRENT_MONTH" = "10" ]; then
          echo "October detected - adding Hacktoberfest label"
          LABELS="good first issue,help wanted,contribution,hacktoberfest"
        else
          LABELS="good first issue,help wanted,contribution"
        fi
        
        # Create the needed number of issues
        for i in $(seq 1 $NEEDED); do
          echo "Creating contribution issue $i of $NEEDED..."
          gh issue create \
            --title "Add your name to Git Gang" \
            --label "$LABELS" \
            --body "Add your name to the contributors list.

## How to contribute

1. Open [ADD_YOUR_NAME.md](https://github.com/SashankBhamidi/git-gang/blob/master/ADD_YOUR_NAME.md)
2. Click the edit icon
3. Fill out:
   - Name: Your Name
   - Username: your-github-username
   - Message: Optional message
4. Open a pull request
5. Automation validates and merges automatically

See [README](https://github.com/SashankBhamidi/git-gang/blob/master/README.md) for details."
        done
        
        echo "âœ… Created $NEEDED contribution issue(s)"
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
